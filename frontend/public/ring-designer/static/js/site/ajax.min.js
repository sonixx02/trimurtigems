function CartManager() {
	this.toolInfo = this.fileData = null;
	this.priceData = {};
	this.priceData.updated = !1;
	this.priceData.shipment = null;
	this.priceData.price = null;
	this.cartInfo = {};
	this.cartInfo.minRange = 31;
	this.cartInfo.maxRange = 69;
	this.cartInfo.step = 1;
	this.currency = "EUR";
	this.toolInfo = {}

}
CartManager.prototype.setFileData = function (a) {
	this.fileData = a;
	this.toolInfo.size = this.getDefaultVal()
};
CartManager.prototype.setSize = function (a) {
	this.toolInfo.size = a
};
CartManager.prototype.saveOrderInfo = function () {
	var a = {};
	$.extend(a, this.fileData.getToolInfo());
	a.size = this.toolInfo.size;
	a.toolType = this.fileData.getToolType();
	return JSON.stringify(a)
};
CartManager.prototype.getSize = function () {
	return this.toolInfo.size
};
CartManager.prototype.getMinRange = function () {
	return this.cartInfo.minRange
};
CartManager.prototype.getMaxRange = function () {
	return this.cartInfo.maxRange
};
CartManager.prototype.getStep = function () {
	return this.cartInfo.step
};
CartManager.prototype.getDefaultVal = function () {
	return this.fileData.getSize()
};
CartManager.prototype.requestPriceData = function () {
	this.priceData.requested = !0;
	this.priceData.requestedSize = this.toolInfo.size;
	this.reset_price();
    setTimeout(function(){
        $(".price").html(gettext("<small>prix indisponible</small>"))
    },
    10);
    /*
	if (this.fileData && this.fileData.isValid()) {
		console.log("sending price request with cookie: " + document.cookie);
		var a = this.computePriceParams(),
		b = this;
		$.ajax({
			type : "POST",
			dataType : "json",
			url : window.media + "/cart/prices/",
			data : a,
			success : function (a) {
				b.priceData = a;
				b.priceData.updated = !0;
				b.priceData.requested = !0;
				b.priceData.requestedSize = b.toolInfo.size;
				b.update_price()
			},
			error : function (a, b, e) {
				$(".price").html(gettext("<small>prix indisponible</small>"))
			}
		})
	}
    */
};
CartManager.prototype.computePriceParams = function () {
	var a = this.getRatio(),
	b;
	b = "volume=" + this.fileData.volume * Math.pow(a, 3);
	b += "&surface=" + this.fileData.surface * Math.pow(a, 2);
	b += "&dimx=" + this.fileData.dimx * a;
	b += "&dimy=" + this.fileData.dimy * a;
	b += "&dimz=" + this.fileData.dimz * a;
	b += "&tooltype=" + this.fileData.getToolType();
	b += "&mat=silver&finish=hg";
	null !== this.fileData.getFileKey() && (b = this.fileData.isCustomization ? b + ("&fid=" + this.fileData.getCustomizationFatherKey()) : b + ("&fid=" + this.fileData.getFileKey()));
	return b
};
CartManager.prototype.reset_price = function () {
	$(".bounding-box-info").css("visibility", "hidden");
	$(".price").html(gettext("<small>Calcul du prix</small>"));
	this.priceData.updated = !1
};
CartManager.prototype.getRatio = function () {
	return this.toolInfo.size / this.fileData.getSize()
};
CartManager.prototype.cut_price = function (a) {
	var b = a.toString();
	a = Math.floor(a).toString();
	var d = "00";
	-1 != b.indexOf(".") && (d = (b.split(".")[1] + "00").substr(0, 2));
	return {
		integer : a,
		decimal : d
	}
};
CartManager.prototype.format_price = function (a) {
	a = this.cut_price(a);
	return a.integer + ".<small>" + a.decimal + "</small>" + window.currency_symbol
};
CartManager.prototype.updateDimBox = function () {
	if (this.fileData.isValid()) {
		var a = this.getRatio();
		$(".bounding-box-info").css("visibility", "visible");
		$(".dim-x").text((Math.round(100 * this.fileData.dimx * a) / 100).toString());
		$(".dim-y").text((Math.round(100 * this.fileData.dimy * a) / 100).toString());
		$(".dim-z").text((Math.round(100 * this.fileData.dimz * a) / 100).toString());
		$(".size-info").text(window.formatTextSize(this.toolInfo.size, this.fileData.getToolType()))
	}
};
CartManager.prototype.update_price = function () {
	if (this.priceData.requested && this.priceData.requestedSize === this.toolInfo.size) {
		if (this.priceData.updated && window.cartSelect.isLoaded) {
			this.updateDimBox();
			var a = window.cartSelect.matSelect.val(),
			b = window.cartSelect.finishSelect[a].val(),
			d = this.priceData.models;
			void 0 === d[a][b] ? $(".price").html(gettext("<small>prix indisponible</small>")) : (this.priceData.price = d[a][b].priceTotal, this.priceData.currency = d[a][b].currency, this.priceData.currency_symbol = d[a][b].currency_symbol,
				0 == d[a][b].priceFabTF ? $(".price").html(gettext("<small>indisponible</small>")) : (a = this.cut_price(this.priceData.price), $(".price").html(a.integer + ".<small>" + a.decimal + "</small> " + this.priceData.currency_symbol)), -1 !== this.priceData.shipment && ($(".shipment").html(gettext("Livraison à <small>") + window.geo.city + ", " + window.geo.country + "</small>: " + (0 == this.priceData.shipment ? gettext("offerte") : this.priceData.shipment.toFixed(2) + " " + this.priceData.currency_symbol)), $(".shipment").css("color", 0 == this.priceData.shipment ?
						"green" : "inherit")))
		}
	} else
		this.requestPriceData()
};
CartManager.prototype.setCurrency = function (a) {
	this.currency = a
};
CartManager.prototype.getPriceSampleJSON = function (a) {
	$.ajax({
		type : "POST",
		dataType : "json",
		url : window.media + "/cart/prices/",
		data : this.fileData.getParams() + "&currency=" + this.currency,
		success : function (b) {
			a([b.models.bronze.npuc, b.models.brass.npuc, b.models.silver.hg, b.models.hdss.satin, b.models.gold.yellow])
		},
		error : function (b, d, c) {
			a(null)
		}
	})
};
CartManager.prototype.getPriceSample = function (a, b, d) {
	void 0 === b && (b = 0);
	void 0 === d && (d = 0);
	a.html($("<img/>", {
			src : window.media + "/static/img/elt/loading.gif",
			css : {
				width : "20px",
				height : "20px",
				position : "absolute",
				top : "0",
				bottom : "0",
				left : "0",
				right : "0",
				margin : "auto"
			}
		}));
	$.ajax({
		type : "POST",
		dataType : "json",
		url : window.media + "/cart/prices/",
		data : this.fileData.getParams(),
		success : function (c) {
			var e = [c.models.bronze.npuc, c.models.brass.npuc, c.models.silver.hg, c.models.hdss.satin, c.models.gold.yellow];
			c = c.models.silver.hg.currency_symbol;
			for (var f = [], g = 0; g < e.length; g++)
				f[g] = 0 == e[g].priceFabTF ? gettext("indisponible") : (e[g].priceTotal * (1 + d) + b).toFixed(0) + c;
			a.html("");
			a.append($("<table/>").append($("<tr/>"), $("<tr/>").append($("<td/>").append(gettext("Bronze")), $("<td/>").append(f[0])), $("<tr/>").append($("<td/>").append(gettext("Metal cuivré")), $("<td/>").append(f[1])), $("<tr/>").append($("<td/>").append(gettext("Argent poli")), $("<td/>").append(f[2])), $("<tr/>").append($("<td/>").append(gettext("Acier")), $("<td/>").append(f[3])),
					$("<tr/>").append($("<td/>").append(gettext("Or")), $("<td/>").append(f[4]))))
		},
		error : function (b, d, f) {
			a.html(gettext("<small>prix indisponible</small>"))
		}
	})
};
CartManager.prototype.getItemThumb = function (a) {
	var b = window.media + "/img/";
	return a.nthumb_small ? b + JSON.parse(a.nthumb_small).key : a.nthumb ? b + JSON.parse(a.nthumb).key : "#"
};
CartManager.prototype.updateCart = function (a) {
	var b = $(".cart-dropdown .dropdown-menu");
	b.children(".dynamic").remove();
	for (var d = [], c = 0; c < a.items.length; c++)
		d[c] = JSON.parse(a.items[c]), d[c].f = JSON.parse(d[c].f);
	a.items = d;
	d = [];
	for (c = 0; c < a.giftvouchers.length; c++)
		d[c] = JSON.parse(a.giftvouchers[c]);
	a.giftvouchers = d;
	c = a.items.length + a.giftvouchers.length;
	$(".nb-cart-items").text(c.toString());
	if (0 == c)
		b.prepend($("<li/>", {
				"class" : "dynamic"
			}).text(gettext("Votre panier est vide."))), $(".cartprice").html(this.format_price(0));
	else {
		for (c = d = 0; c < a.items.length; c++)
			d += a.items[c].priceTotal / 100;
		for (c = 0; c < a.giftvouchers.length; c++)
			d += a.giftvouchers[c].priceTotal / 100;
		$(".cartprice").html(this.format_price(d));
		b.prepend($("<hr/>", {
				"class" : "dynamic"
			}));
		b.prepend('<li class="dynamic"><button type="button" class="btn order-trigger">' + gettext("Commander") + "</button></li>");
		for (c = 0; c < a.giftvouchers.length; c++)
			b.prepend($("<li/>", {
					"class" : "cartitem dynamic"
				}).append($("<table>").append($("<tr/>").append($("<td/>").append($("<img/>", {
									src : window.media + "/static/img/elt/gift.png",
									css : {
										"background-color" : "transparent",
										padding : "20px"
									}
								})), $("<td/>").append($("<div/>", {
									"class" : "giftvoucher-name"
								}).html(gettext("Chèque-cadeau")), $("<div/>", {
									"class" : "giftvoucher-dest"
								}).html(a.giftvouchers[c].dest), $("<div/>", {
									"class" : "giftvoucher-price"
								}).html("prix: <b>" + window.format_price(a.giftvouchers[c].priceTotal / 100) + "</b>")))), $("<button/>", {
						"class" : "cartitem-delete",
						"data-id" : a.giftvouchers[c].key,
						title : gettext("supprimer")
					}).text("X")));
		for (c =
				0; c < a.items.length; c++)
			d = JSON.parse(a.items[c].toolInfo), d = window.formatTextSize(d.size, d.toolType), b.prepend($("<li/>", {
					"class" : "cartitem dynamic"
				}).append($("<table>").append($("<tr/>").append($("<td/>").append($("<img/>", {
									src : this.getItemThumb(a.items[c].f),
									load : function () {
										$(this).off("load");
										var b = $(this).closest(".cart-dropdown").find(".cartitem img").index($(this)),
										b = a.items.length - (b + 1);
										console.log("load image material " + a.items[b].material[0] + " for item " + a.items[b].f.name);
										$(this);
										window.imageManager.loadImageMaterial($(this)[0],
											$(this)[0], a.items[b].material[0], a.items[b].finish[0])
									}
								})), $("<td/>").append($("<div/>", {
									"class" : "cartitem-name"
								}).html(a.items[c].f.name), $("<div/>", {
									"class" : "cartitem-mat",
									"data-mat" : a.items[c].material[0]
								}).html("<b>" + a.items[c].material[1] + "</b>"), $("<div/>", {
									"class" : "cartitem-finish",
									"data-finish" : a.items[c].finish[0]
								}).text(a.items[c].finish[1]), $("<div/>", {
									"class" : "cartitem-size"
								}).text(d), $("<div/>", {
									"class" : "cartitem-price"
								}).html("prix: <b>" + this.format_price(a.items[c].priceTotal / 100) +
									"</b>")))), $("<button/>", {
						"class" : "cartitem-delete",
						"data-id" : a.items[c].key,
						title : gettext("supprimer")
					}).text("X")));
		$(".cartitem-delete").click(this.instanciateCartDel());
		$(".order-trigger").click(function () {
			location.href = window.base_lang_url + "/checkout/"
		})
	}
};
CartManager.prototype.refresh = function (a) {
	var b = this;
	$.ajax({
		type : "GET",
		dataType : "json",
		url : window.media + "/cart/get/",
		success : function (d) {
			b.updateCart(d);
			a && a()
		}
	})
};
CartManager.prototype.instanciateCartDel = function () {
	var a = this;
	return function () {
		var b = $(this).data("id");
		$(this).closest(".cartitem").fadeOut();
		$.ajax({
			type : "GET",
			dataType : "json",
			url : window.media + "/cart/del/" + b,
			success : function (b) {
				a.updateCart(b)
			},
			error : function (a, b, e) {
				window.userMsgs.customErrorMsg(gettext("Erreur lors de l'effacement de votre panier."))
			}
		})
	}
};
CartManager.prototype.instanciateAddToCart = function () {
	var a = this;
	return function () {
		a.fileData.tool.prepToolForSave(function (b) {
			a.fileData.saveObj(gettext("Vous devez sauvegarder cet objet avant de pouvoir l'ajouter à votre panier. Sous quel nom voulez-vous le sauvegarder?"), function (d) {
				a.addCart();
				b()
			});
			return !1
		});
		return !1
	}
};
CartManager.prototype.instanciateAddCartNoSave = function () {
	var a = this;
	return function () {
		a.fileData.isLoggedIn(function () {
			a.addCart();
			return !1
		}, window.userMsgs.needToBeRegisteredMsgError)
	}
};
CartManager.prototype.addCart = function () {
	var a = window.cartSelect.matSelect.val(),
	b = window.cartSelect.finishSelect[a].val(),
	d;
	d = "&fileid=" + this.fileData.fileKey;
	d += "&ratio=" + this.getRatio();
	d = d + ("&mat=" + a) + ("&finish=" + b);
	d += "&quantity=1";
	d += "&toolInfo=" + encodeURIComponent(this.saveOrderInfo());
	var c = this;
	$.ajax({
		type : "POST",
		dataType : "json",
		url : window.media + "/cart/add/",
		data : d,
		success : function (a) {
			0 === a ? (window.userMsgs.customErrorMsg(gettext("Vous ne pouvez pas ajouter cet objet au panier, le prix est indisponible.")),
				_track.evt("addToCartErrorNoLoggedIn")) : (c.updateCart(a), _track.evt("addToCart"))
		},
		error : function () {
			window.userMsgs.customErrorMsg(gettext("Vous ne pouvez pas ajouter cet objet au panier, ce matériau ou cette finition est indisponible pour l'instant."));
			_track.evt("addToCartError")
		}
	});
	return !1
};
var CartSelectManager = function (a, b) {
	this.wrapperFinish = this.matSelect = null;
	this.finishSelect = {};
	this.finishDesc = $("<div/>", {
			"class" : "finish-desc text-right"
		});
	this.finish = this.mat = null;
	this.isLoaded = !1;
	a && b && (this.matSelect = a, this.wrapperFinish = b, this.initSelects())
};
CartSelectManager.prototype.runWhenInitialized = function (a) {
	if (window.cartSelect.isLoaded)
		console.log("runWhenInitialized: isLoaded is true on the first run! Calling callback."), a();
	else {
		var b = function () {
			window.cartSelect.isLoaded ? (console.log("runWhenInitialized: isLoaded is true after ajaxStop. Calling callback."), $(document).unbind("ajaxStop"), a()) : (console.log("runWhenInitialized: ajaxStop called but isLoad is still not true ! Rebinding !"), $(document).ajaxStop(b))
		};
		$(document).ajaxStop(b)
	}
};
CartSelectManager.prototype.initSelects = function () {
	var a = this;

    var b = {
        "hdss" : {
            "matt" : ["Mate", "Printed steel, solid. Grainy look."],
            "gloss" : ["Poli", "Printed steel, solid and polished."],
            "satin" : ["Satin", "Printed Steel, Grainy look."]
        },
        "gold" : {
            "yellow18" : ["Jaune 18c", "Yellow gold (18k), Hand polished.."],
            "yellow" : ["Jaune 14c", "Yellow gold (14k), Hand polished."],
            "red18" : ["Rose 18c", "Red gold (18k), Hand polished."],
            "white" : ["Blanc 14c", "White gold (14k), Hand polished."],
            "white18" : ["Blanc 18c", "White gold (18k), Hand polished."],
            "red" : ["Rose 14c", "Red gold (14k), Hand polished."]
        },
        "titanium" : {
            "lg" : ["Unpolished (light grained)", "Unpolished Titanium. Grainy look."],
            "lgp" : ["Polished", "Polished titanium. Maximum strength."]
        },
        "brass" : {
            "npuc" : ["Verni", "Brass, Magnet Polish."],
            "gp" : ["Gold Plated, Hand polished.", "Brass, Gold plated (14k)."]
        },
        "silver" : {
            "antique" : ["Antic (Oxidized)", ".925 Silver, oxidized then hand polished"],
            "sb" : ["Sandblasted", "Sterling Silver, Matt look."],
            "gloss" : ["Standard", "Sterling silver, Antique look."],
            "hg" : ["Premium", "Sterling Silver, Gloss. Hand polished."]
        },
        "bronze" : {
            "ppuc" : ["Polished", "Polished bronze"],
            "nu" : ["Raw grain, Unpolished", "Raw bronze, unpolished"],
            "npuc" : ["Non poli, Verni", "Small grain bronze, unpolished"]
        }
    };

    setTimeout(function(){
        console.log("building select pickers");
        for (var d = Object.keys(b), c = 0; c < d.length; c++) {
            var e = d[c],
            f = "select-" + e + "-finish";
            a.finishSelect[e] = $("<select/>", {
                    id : f,
                    name : f
                });
            for (var f = b[e], g = Object.keys(f), h = 0; h < g.length; h++) {
                var k = g[h],
                l = f[k][0];
                a.finishSelect[e].append($("<option/>", {
                        value : k,
                        "data-desc" : f[k][1]
                    }).text(l))
            }
            a.wrapperFinish.append(a.finishSelect[e]);
            a.wrapperFinish.append(a.finishDesc);
            a.finishSelect[e].selectpicker();
            a.finishSelect[e].change(function () {
                a.finishDesc.text("" + $(this).children("option:selected").data("desc"));
                a.updateMaterialOnTool();
                window.cartData.update_price()
            });
            a.finishSelect[e].selectpicker("hide")
        }
        a.matSelect.selectpicker();
        a.matSelect.change(function () {
            a.update_finish(a.matSelect.val(), null);
            a.updateMaterialOnTool()
        });
        a.isLoaded = !0;
        b = "silver";
        d = "hg";
        null !== a.mat && null !== a.finish && (b = a.mat, d = a.finish);
        a.updateMaterialSelects(b,
            d)
    },
    10);
};
CartSelectManager.prototype.updateFinishDesc = function () {};
CartSelectManager.prototype.addChangeFunction = function (a) {
	window.cartSelect.matSelect.change(function () {
		a()
	});
	for (var b = window.cartSelect.finishSelect, d = Object.keys(b), c = 0; c < d.length; c++)
		b[d[c]].change(function () {
			a()
		})
};
CartSelectManager.prototype.update_finish = function (a, b) {
	for (var d = Object.keys(this.finishSelect), c = 0; c < d.length; c++)
		this.finishSelect[d[c]].selectpicker("hide");
	this.finishSelect[a].selectpicker("show");
	void 0 !== b && null !== b ? this.finishSelect[a].selectpicker("val", b) : (d = $(this.finishSelect[a]).children("option:selected").val(), this.finishSelect[a].selectpicker("val", d));
	this.finishSelect[a].selectpicker("refresh")
};
CartSelectManager.prototype.updateMaterialSelects = function (a, b) {
	this.mat = a;
	this.finish = b;
	this.isLoaded && (this.matSelect.selectpicker("val", a), this.update_finish(a, b), this.matSelect.selectpicker("refresh"))
};
CartSelectManager.prototype.updateMaterialOnTool = function () {
	if (void 0 !== this.matSelect && void 0 !== this.finishSelect) {
		var a = this.matSelect.val(),
		b = this.finishSelect[a].val();
		if (window.onUpdateMaterial)
			window.onUpdateMaterial();
		this.updateTwoDViewer(a, b)
	}
};
CartSelectManager.prototype.updateTwoDViewer = function (a, b) {
	for (var d = $(".object-nthumb"), c = $(".object-thumb"), e = 0; e < d.length; e++) {
		var f = d[e],
		g = c[e];
		if (f.complete)
			window.imageManager.loadImageMaterial(f, g, a, b);
		else
			$(f).on("load", function () {
				window.imageManager.loadImageMaterial(f, g, a, b)
			})
	}
};
function FileManager(a) {
	this.fileName = "";
	this.customizationFatherKey = this.fatherKey = this.fileKey = "0";
	this.isCustomization = !1;
	this.designerVarMargin = this.designerFixMargin = 0;
	this.dimz = this.dimy = this.dimx = this.surface = this.volume = null;
	this.tool = a;
	this.tool instanceof site.LoaderNode ? this.hasBeenSaved = this.validDim = !1 : a && (this.hasBeenSaved = this.validDim = !0, this.volume = a.volume, this.surface = a.surface, this.dimx = a.dimx, this.dimy = a.dimy, this.dimz = a.dimz, this.tool.prepToolForSave = function () {
			console.error("FileManager - prepToolForSave: No saving available for a viewed object")
		},
			this.tool.engineIsEmpty = function () {
			return !1
		}, this.tool.toolInfo = JSON.parse(a.toolInfo))
}
FileManager.prototype.setCustomization = function () {
	this.isCustomization = !0
};
FileManager.prototype.getSize = function () {
	return this.tool.toolInfo.size
};
FileManager.prototype.getToolType = function () {
	return this.tool.toolType
};
FileManager.prototype.updateObjectData = function (a, b, d) {
	d = d.map(function (a) {
			return a / 10
		});
	this.volume = a / 1E6;
	this.surface = b / 1E4;
	this.dimx = d[3] - d[0];
	this.dimy = d[4] - d[1];
	this.dimz = d[5] - d[2];
	this.validDim = !0
};
FileManager.prototype.isValid = function () {
	return this.validDim && !this.tool.engineIsEmpty()
};
FileManager.prototype.setvalidDim = function (a) {
	this.validDim = a
};
FileManager.prototype.isLoggedIn = function (a, b) {
	$.ajax({
		type : "POST",
		url : window.media + "/u/islogged/",
		success : a,
		error : b
	})
};
FileManager.prototype.hideSavingBlock = function () {
	$("#saving-button").fadeOut(0, function () {
		$("#file-button-list").fadeIn()
	})
};
FileManager.prototype.showSavingBlock = function () {
	$("#file-button-list").fadeOut(0, function () {
		$("#saving-button").fadeIn()
	})
};
FileManager.prototype.getParams = function () {
	var a;
	a = "volume=" + this.volume;
	a += "&surface=" + this.surface;
	a += "&dimx=" + this.dimx;
	a += "&dimy=" + this.dimy;
	a += "&dimz=" + this.dimz;
	a += "&tooltype=" + this.tool.toolType;
	a += "&fid=" + this.fileKey;
	a += "&fatherKey=" + this.fatherKey;
	return a += "&customization=" + this.isCustomization
};
FileManager.prototype.image2Blob = function (a, b) {
	for (var d = Array(a.length), c = 0; c < a.length; c++)
		d[c] = a.charCodeAt(c);
	d = new Uint8Array(d);
	return new Blob([d], {
		type : b
	})
};
FileManager.prototype.request_save = function (a, b, d) {
	var c = new FormData,
	e = window.cartSelect.matSelect.val(),
	f = window.cartSelect.finishSelect[e].val();
	c.append("name", a);
	c.append("thumb", this.image2Blob(b.basic.full), "big.png");
	c.append("thumb_small", this.image2Blob(b.basic.thumb), "small.png");
	c.append("nthumb", this.image2Blob(b.normal_map.full), "nbig.png");
	c.append("nthumb_small", this.image2Blob(b.normal_map.thumb), "nsmall.png");
	c.append("key", this.getFileKey());
	c.append("fatherkey", this.getFatherKey());
	c.append("tooltype", this.getToolType());
	c.append("jsonInfo", this.tool.savejsonInfo());
	c.append("toolInfo", this.tool.saveToolInfo());
	c.append("volume", this.volume.toString());
	c.append("surface", this.surface.toString());
	c.append("dimx", this.dimx.toString());
	c.append("dimy", this.dimy.toString());
	c.append("dimz", this.dimz.toString());
	c.append("material", e);
	c.append("finish", f);
	c.append("campos", this.tool.getCamPos());
	var g = this;
	$.ajax({
		type : "POST",
		data : c,
		contentType : !1,
		processData : !1,
		url : window.media +
		"/f/save/",
		success : function (b) {
			g.hideSavingBlock();
			g.setFileName(a);
			g.setFileKey(b);
			g.tool.notifySave();
			console.log("saved file under id " + b);
			window.history.replaceState("Object", "Title", window.base_lang_url + "/edit/" + b + "/");
			void 0 !== d && d(b);
			_track.evt("savedObject", {
				id : b
			})
		},
		error : function () {
			g.hideSavingBlock();
			window.userMsgs.customErrorMsg(gettext("Votre objet n'a pas pu être sauvé. Peut-être a-t-il été publié ?"));
			_track.evt("savedObjectError")
		}
	})
};
FileManager.prototype.request_admsave = function (a, b, d) {
	var c = new FormData,
	e = window.cartSelect.matSelect.val(),
	f = window.cartSelect.finishSelect[e].val();
	c.append("thumb", this.image2Blob(b.basic.full), "big.png");
	c.append("thumb_small", this.image2Blob(b.basic.thumb), "small.png");
	c.append("nthumb", this.image2Blob(b.normal_map.full), "nbig.png");
	c.append("nthumb_small", this.image2Blob(b.normal_map.thumb), "nsmall.png");
	c.append("jsonInfo", this.tool.savejsonInfo());
	c.append("toolInfo", this.tool.saveToolInfo());
	c.append("key", this.getFileKey());
	c.append("volume", this.volume.toString());
	c.append("surface", this.surface.toString());
	c.append("dimx", this.dimx.toString());
	c.append("dimy", this.dimy.toString());
	c.append("dimz", this.dimz.toString());
	c.append("material", e);
	c.append("finish", f);
	c.append("campos", this.tool.getCamPos());
	var g = this;
	$.ajax({
		type : "POST",
		data : c,
		contentType : !1,
		processData : !1,
		url : window.media + "/f/admsave/",
		success : function (b) {
			g.hideSavingBlock();
			g.setFileName(a);
			g.setFileKey(b);
			g.tool.notifySave();
			console.log("saved file under id " + b);
			void 0 !== d && d(b)
		},
		error : function () {
			g.hideSavingBlock();
			window.userMsgs.customErrorMsg(gettext("Votre objet n'a pas pu être sauvé. Peut-être a-t-il été publié ?"))
		}
	})
};

FileManager.prototype.saveObj = function (a, b) {
	var d = a || gettext("Comment voulez-vous appeler votre création ?"),
	c = this;
	setTimeout(function () {
		console.log("saving the object");
		var a = c.getFileName();
		"" === a ? bootbox.prompt(d, function (a) {
			null !== a && (a = a.trim().slice(0, 22), "" !== a && (null !== a && "" !== a ? (c.showSavingBlock(), c.tool.takeScreenshots("#viewerCanvas", function (d) {
							var json = {
								"tooltype" : c.getToolType(),
								"jsonInfo" : c.tool.savejsonInfo(),
								"toolInfo" : c.tool.saveToolInfo()
							};
							window.downloadFile(new Blob([JSON.stringify(json, null, 2)], {
									type : 'application/json'
								}), a, ".jweel");
							if (b !== undefined) {
								b({});
							}
							c.hideSavingBlock();
							c.setFileName(a);
							c.tool.notifySave();
							//return c.request_save(a, d, b)
						})) : window.userMsgs.customErrorMsg(gettext("Ce nom d'objet n'est pas valide."))))
		}) : (c.showSavingBlock(), c.tool.takeScreenshots("#viewerCanvas",
				function (d) {
				var json = {
					"tooltype" : c.getToolType(),
					"jsonInfo" : c.tool.savejsonInfo(),
					"toolInfo" : c.tool.saveToolInfo()
				};
				window.downloadFile(new Blob([JSON.stringify(json, null, 2)], {
						type : 'application/json'
					}), a, ".jweel");
				if (b !== undefined) {
					b({});
				}
				c.hideSavingBlock();
				c.setFileName(a);
				c.tool.notifySave();
				//return c.request_save(a, d, b)
			}))
	},
    10);
};

FileManager.prototype.admSaveObj = function (a, b) {
	a || gettext("Comment voulez-vous appeler votre création ?");
	var d = this;
	this.isLoggedIn(function () {
		console.log("saving the object");
		var a = d.getFileName();
		d.showSavingBlock();
		d.tool.takeScreenshots("#viewerCanvas", function (e) {
			return d.request_admsave(a, e, b)
		})
	}, window.userMsgs.needToBeRegisteredMsgError)
};
FileManager.prototype.rateObj = function (a, b, d) {
	var c = window.readCookie("rating");
	if (null != c && (c = JSON.parse(c), -1 != $.inArray(a, c))) {
		_track.evt("ratedObjError", {
			alreadyRated : !0
		});
		window.userMsgs.customErrorMsg(gettext("Désolé, vous ne pouvez plus noter cet objet."));
		return
	}
	$.ajax({
		type : "POST",
		dataType : "json",
		url : window.media + "/f/rate/" + a,
		data : "mark=" + b,
		success : function (b) {
			_track.evt("ratedObject", {
				id : a
			});
			var c = window.readCookie("rating"),
			c = null == c ? [] : JSON.parse(c);
			c.push(a);
			window.createCookie("rating",
				JSON.stringify(c), 365);
			bootbox.alert("Merci, votre vote a été pris en compte");
			d && d(b)
		},
		error : function () {
			window.userMsgs.customErrorMsg(gettext("Désolé, vous ne pouvez plus noter cet objet."));
			_track.evt("ratedObjError")
		}
	})
};
FileManager.prototype.voteObj = function (a, b) {
	$.ajax({
		type : "GET",
		dataType : "json",
		url : window.media + "/f/vote/" + a,
		success : function (d) {
			_track.evt("votedObject", {
				id : a
			});
			b && b(d)
		},
		error : function () {
			window.userMsgs.customErrorMsg(gettext("Vous n'êtes pas connecté, ou avez déjà voté pour cet objet."));
			_track.evt("votedObjectError")
		}
	})
};
FileManager.prototype.instanciateSave = function () {
	var a = this;
	return function () {
		a.tool.prepToolForSave(function (b) {
			a.saveObj(gettext("Comment voulez-vous appeler votre création ?"), function (d) {
				//bootbox.alert(gettext("Votre création a été sauvegardée sous le nom: ") + a.getFileName());
				b()
			})
		})
	}
};
FileManager.prototype.instanciateAdmSave = function () {
	var a = this;
	return function () {
		a.tool.prepToolForSave(function (b) {
			a.admSaveObj(gettext("Comment voulez-vous appeler votre création ?"), function (d) {
				bootbox.alert(gettext("Votre création a été sauvegardée sous le nom: ") + a.getFileName());
				b()
			})
		})
	}
};
FileManager.prototype.instanciateCopy = function () {
	var a = this;
	return function () {
		bootbox.prompt(gettext("Comment voulez-vous appeler la copie de votre création ?"), function (b) {
			null !== b && (b = b.trim().slice(0, 22), "" !== b ? (a.setFatherKey(a.getFileKey()), a.setFileKey("0"), a.setFileName(b), a.tool.prepToolForSave(function (b) {
						a.saveObj(gettext("Comment voulez-vous appeler votre création ?"), function (c) {
							bootbox.alert(gettext("Votre création a été sauvegardée sous le nom: ") + a.getFileName());
							_track.evt("copyObject", {
								id : c
							});
							b()
						})
					})) : (window.userMsgs.customErrorMsg(gettext("Ce nom d'objet n'est pas valide.")), _track.evt("copyObjectError")))
		})
	}
};
FileManager.prototype.instanciatePublish = function () {
	var a = this;
	return function () {
		a.tool.prepToolForSave(function (b) {
			a.saveObj(gettext("Vous êtes sur le point de publier votre création. Sous quel nom voulez-vous la sauvegarder?"), function (a) {
				window.location.replace(window.base_lang_url + "/pub/" + a + "/");
				b()
			})
		})
	}
};
FileManager.prototype.resetFileData = function () {
	this.setFileKey("0");
	this.setFileName("");
	_track.evt("resetObject")
};
FileManager.prototype.setFileName = function (a) {
	this.fileName = a.trim().slice(0, 22)
};
FileManager.prototype.setFileKey = function (a) {
	this.fileKey = a
};
FileManager.prototype.setFatherKey = function (a) {
	this.fatherKey = a
};
FileManager.prototype.setCustomizationFatherKey = function (a) {
	this.customizationFatherKey = a
};
FileManager.prototype.loadToolInfo = function (a) {
	this.tool.toolInfo = JSON.parse(a)
};
FileManager.prototype.getToolInfo = function () {
	return this.tool.toolInfo
};
FileManager.prototype.getFileName = function () {
	return void 0 === this.fileName ? "" : this.fileName
};
FileManager.prototype.getFileKey = function () {
	return void 0 === this.fileKey ? "0" : this.fileKey
};
FileManager.prototype.getFatherKey = function () {
	return void 0 === this.fatherKey ? "0" : this.fatherKey
};
FileManager.prototype.getCustomizationFatherKey = function () {
	return void 0 === this.customizationFatherKey ? "0" : this.customizationFatherKey
};
FileManager.prototype.sendPublish = function (a, b) {
	var d = new FormData;
	d.append("name", this.getFileName());
	d.append("desc", a);
	_track.evt("publishObject", {
		id : this.getFileKey()
	});
	$.ajax({
		type : "POST",
		data : d,
		contentType : !1,
		processData : !1,
		url : window.media + "/f/pub/" + this.getFileKey(),
		success : b.sucess,
		error : b.error,
		xhr : b.xhr
	})
};
FileManager.prototype.instanciateResetEverything = function () {
	var a = this;
	return function () {
		a.tool.prepToolForSave(function (b) {
			skim.file.isSaved() ? (a.resetFileData(), a.tool.resetEverything()) : bootbox.dialog({
				message : gettext("Voulez-vous vraiment créer un nouvel objet ? Votre objet en cours n'est pas sauvegardé, voulez vous:"),
				title : gettext("Nouvel Objet"),
				buttons : {
					cancel : {
						label : gettext("Annuler"),
						className : "btn btn-blue",
						callback : function () {}

					},
					connect : {
						label : gettext("Créer sans sauver"),
						className : "btn btn-blue",
						callback : function () {
							a.resetFileData();
							a.tool.resetEverything()
						}
					},
					register : {
						label : gettext("Sauver puis créer"),
						className : "btn btn-blue",
						callback : function () {
							a.saveObj(gettext("Comment voulez-vous appeler votre création ?"), function (d) {
								bootbox.alert(gettext("Votre création a été sauvegardée et vous pouvez maintenant créer un nouvel objet."));
								a.resetFileData();
								a.tool.resetEverything();
								b()
							})
						}
					}
				}
			})
		})
	}
};
